<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>CSV text to speech synthesizer</title>
  </head>
  <body>
    <h1>CSV text to speech synthesizer</h1>
    <fieldset>
      <p>Please choose a CSV file</p>
      <div class ="form-row">
          <label for="words">Words to be synthesised:</label>
          <input type="file"
                 id="words" name="words"
                 accept=".csv">
      </div>
      <button type="button" id="confirm">Synthesise</button>
    </fieldset>
    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
    <script type="text/javascript" src = "papaparse.js"></script>
    <script type="text/javascript">

      function parseCSV(file) {
        return new Promise((resolve, reject) => {
          Papa.parse(file, {
            error: reject,
            complete: resolve,
          })
        })
      }

      // let text = "Hello";
      // let folderName = "greetings"
      // $.ajax({
      //   contentType: 'application/json',
      //   url: "https://api.soundoftext.com/sounds",
      //   type: "POST",
      //   data: JSON.stringify({
      //     "engine": "Google",
      //     "data": {
      //       "text": text,
      //       "voice": "en-GB"
      //     }
      //   })
      // }).then(result => {
      //   console.log(result)
      //   let id = result["id"];
      //
      //   $.ajax({
      //     url: `https://api.soundoftext.com/sounds/${id}`,
      //     type: "GET",
      //   }).then(result => {
      //     let url = result.location;
      //     console.log(url)
      //
      //     $.ajax({
      //       url: "/addURL",
      //       type: "POST",
      //       data: {
      //         url: url,
      //         text: text,
      //         folderName: folderName,
      //       },
      //     }).then(response => {
      //       console.log(response);
      //     }).catch(e => console.log(e));
      //
      //   })
      //
      // })



      $("#confirm").click(() => {
        let file = document.getElementById("words").files[0];
        console.log(file)
        let folderName = file.name.slice(0, -4); // remove .csv extension with slice


        parseCSV(file).then(result => {
          let vocabList = result.data;
          let vocabArray = [];
          let urlArray = [];

          vocabList.forEach(item => {
            if(item[0] != "English" || item[0] != "") { // skip header row and empty cells
              vocabArray.push(item[0]);
            }
          })

          console.log(vocabArray);

          vocabArray.forEach(item => {
            let index = vocabArray.indexOf(item) + 1;

            $.ajax({
              contentType: 'application/json',
              url: "https://api.soundoftext.com/sounds",
              type: "POST",
              data: JSON.stringify({
                "engine": "Google",
                "data": {
                  "text": item,
                  "voice": "en-GB"
                }
              })
            }).then(result => {

              let id = result["id"];
              console.log(`id for ${item}: ${id}`);

              $.ajax({
                url: `https://api.soundoftext.com/sounds/${id}`,
                type: "GET",
              }).then(result => {
                let url = result.location;
                console.log(`URL for ${item}: ${url}`)

                console.log(`Posting ${item} to server...`)
                $.ajax({
                  url: "/addURL",
                  type: "POST",
                  data: {
                    url: url,
                    text: item,
                    folderName: folderName,
                    index: index,
                  },
                }).then(response => {

                }).catch(e => console.log(e));

              })
            })
          })

        })
      })
    </script>

  </body>
</html>
